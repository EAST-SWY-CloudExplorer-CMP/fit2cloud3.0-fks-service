<div layout-fill class="content-backdrop" ng-controller="OrderController" ng-cloak>
    <div layout="column" layout-fill>
        <md-toolbar class="content-toolbar">
            <div class="md-toolbar-tools">
                <label>订单列表</label>
            </div>
        </md-toolbar>
        <div layout="row" flex cg-busy="{promise:loadingLayer,minDuration:500}">
            <div class="md-padding" layout="column" flex="100">
                <filter-tools conditions="conditions" results="filters" search="'true'"
                              execute="list()">
                    <div class="filter-item">
                        <md-button class="md-icon-button md-whiteframe-1dp" ng-click="list()">
                            <md-tooltip md-delay="300">刷新</md-tooltip>
                            <md-icon>refresh</md-icon>
                        </md-button>
                    </div>
                </filter-tools>
                <div flex layout="column" layout-fill>
                    <table dynamic-table columns="columns" execute="list({sql: sql})">
                        <tbody>
                        <tr ng-repeat="item in items"
                            ng-class="{'tr-selected':selected === item.$$hashKey}">
                            <td ng-switch="item.type">
                                <span ng-switch-when="CREATE">虚拟机申请</span>
                                <span ng-switch-when="UPDATE">虚拟机配置变更</span>
                                <span ng-switch-when="DELETE">虚拟机回收</span>
                                <span ng-switch-when="DISK_UPDATE">磁盘变更</span>
                                <span ng-switch-when="DISK_CREATE">磁盘创建</span>
                                <span ng-switch-when="DISK_ENLARGE">磁盘扩容</span>
                                <span ng-switch-when="SERVER_EXPIRE_UPDATE">虚拟机续期申请</span>
                                <span ng-switch-default>{{item.type}}</span>
                            </td>
                            <td>
                                <a class="md-primary text-click" ng-click="showOrderDetail(item, 'view')">
                                    {{item.id}}
                                </a>
                            </td>
                            <td ng-bind="item.organizationName"></td>
                            <td>
                                <workspace-info id="item.workspaceId"></workspace-info>
                            </td>
                            <td ng-bind="item.createTime | date:'yyyy-MM-dd HH:mm'"></td>
                            <td>
                                <user-info user-id="item.applyUser"></user-info>
                            </td>
                            <td ng-switch="item.status">
                                <span ng-switch-when="UNCHECKED">审批中</span>
                                <span ng-switch-when="APPROVED">已审批</span>
                                <span ng-switch-when="TERMINATED">已终止</span>
                                <span ng-switch-when="CANCELED">已作废</span>
                                <span ng-switch-when="REJECTED">已驳回</span>
                                <span ng-switch-when="PROCESSING">
                                    <button ng-click="showOrderLog(item)" class="order-button order-button-processing">
                                        <i class="fas fa-sync-alt fa-spin"></i>&nbsp;正在处理...
                                    </button>
                                </span>
                                <span ng-switch-when="FINISHED">
                                    <button ng-click="showOrderLog(item)" class="order-button order-button-success">已完成</button>
                                </span>
                                <span ng-switch-when="ERROR">
                                    <button ng-click="showOrderLog(item)" class="order-button order-button-error">异常</button>
                                </span>
                                <span ng-switch-when="WARNING">
                                    <button ng-click="showOrderLog(item)" class="order-button order-button-warning">告警</button>
                                </span>
                            </td>
                            <td ng-init="getExtendInfo(item)">
                                <div ng-if="!item.resources">
                                    &nbsp;加载中...
                                </div>
                                <div ng-if="item.resources">
                                    <a ng-click="goResource(item)" ng-if="item.vmCount>0" class="md-primary" href=""
                                       style="cursor:pointer; text-decoration: underline;">
                                        {{item.vmCount}}个<span ng-if="!item.ifDisk">虚拟机</span><span ng-if="item.ifDisk">云磁盘</span>
                                    </a>
                                </div>
                            </td>
                            <td>
                                <table-menus>
                                    <md-menu-item>
                                        <md-button ng-click="showOrderDetail(item, 'view')">
                                            <md-icon class="md-18">view_headline</md-icon>
                                            查看订单
                                        </md-button>
                                    </md-menu-item>
                                    <md-menu-item
                                            ng-if="item.status == 'PROCESSING' || item.status == 'FINISHED' || item.status == 'WARNING' || item.status == 'ERROR' || item.status == 'CANCELED'">
                                        <md-button ng-click="showOrderLog(item)">
                                            <md-icon class="md-18">cloud_done</md-icon>
                                            查看资源日志
                                        </md-button>
                                    </md-menu-item>
                                    <md-menu-item ng-if="isAdmin && (item.status === 'ERROR' || item.status === 'WARNING')"
                                                  has-permission="ORDER:RETRY">
                                        <md-button ng-click="showOrderDetail(item, 'retry')">
                                            <md-icon class="md-18">redo</md-icon>
                                            重试订单
                                        </md-button>
                                    </md-menu-item>
                                    <md-menu-item ng-if="isAdmin && (item.status === 'ERROR' || item.status === 'WARNING')"
                                                  has-permission="ORDER:CANCEL">
                                        <md-button ng-click="cancelOrder(item)">
                                            <md-icon class="md-18">delete</md-icon>
                                            作废订单
                                        </md-button>
                                    </md-menu-item>
                                    <!--<md-menu-item ng-if="isUser && item.type == 'CREATE'" has-permission="CATALOG_PRODUCT:APPLY">-->
                                    <!--<md-button ng-click="copyOrder(item)">-->
                                    <!--<md-icon class="md-18">file_copy</md-icon>-->
                                    <!--复制订单-->
                                    <!--</md-button>-->
                                    <!--</md-menu-item>-->
                                </table-menus>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <table-pagination pagination="pagination"></table-pagination>
                </div>
            </div>
        </div>
        <md-sidenav class="md-sidenav-right side-form md-whiteframe-4dp" md-disable-close-events="false" style="width: 70%; overflow: hidden;" md-component-id="right-1">
            <div ng-include="formUrl" style="height: 100%"></div>
        </md-sidenav>
    </div>
</div>
